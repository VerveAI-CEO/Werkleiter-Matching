<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matching System</title>
<style>
:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --success-color: #27ae60;
    --commercial-color: #9b59b6;
    --technical-color: #e67e22;
}
* { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
body { background-color:#f5f7fa; color:#333; line-height:1.6; padding:20px; }
.container { max-width:1000px; margin:0 auto; }
header { background-color:var(--primary-color); color:white; padding:1.5rem; text-align:center; margin-bottom:2rem; border-radius:10px; }
.input-section, .results-section { background:white; padding:25px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.form-group { margin-bottom:1.5rem; }
label { display:block; margin-bottom:0.5rem; font-weight:bold; color:#444; }
input, textarea, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:5px; font-size:1rem;}
textarea { min-height:80px; resize:vertical; }
.btn { background-color:var(--secondary-color); color:white; border:none; padding:12px 20px; border-radius:5px; cursor:pointer; font-size:1rem; font-weight:600; transition: background-color 0.3s; }
.btn-success { background-color: var(--success-color);}
.btn:hover { background-color:#2980b9;}
.btn-success:hover { background-color:#219955;}
.participant-card { background:#f8f9fa; border:1px solid #dee2e6; border-radius:5px; padding:15px; margin-bottom:15px; }
.role-badge { padding:3px 8px; border-radius:3px; font-size:0.8rem; font-weight:bold; color:white; margin-left:10px; }
.role-commercial { background-color: var(--commercial-color);}
.role-technical { background-color: var(--technical-color);}
.loading { text-align:center; padding:30px; }
.spinner { border:5px solid #f3f3f3; border-top:5px solid var(--secondary-color); border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto 15px;}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
.explanation-full { background:#f0f4f8; padding:10px; border-radius:5px; margin-top:5px; display:none; }
#adminLoginBtn { display:block; margin:30px auto; text-align:center; font-size:16px; color:gray; cursor:pointer; text-decoration:underline; }
</style>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>

<!-- Customer Section -->
<div id="customerSection" style="max-width:600px; margin:0 auto;">
<h2 style="text-align:center;">Participation Form</h2>
<form id="customerForm">
<label>Name</label><input id="c-name" required>

<label>Role</label>
<select id="c-role" required>
  <option value="">Select Role</option>
  <option value="commercial">Commercial</option>
  <option value="technical">Technical</option>
</select>

<label>Factory / Location</label><input id="c-factory" required>
<label>We offer</label><textarea id="c-offer" required></textarea>
<label>We seek</label><textarea id="c-seek" required></textarea>
<label>Key Takeaways</label><textarea id="c-key-takeaways"></textarea>
<label>Contact Partners</label><textarea id="c-contact-partners"></textarea>
<button class="btn" style="margin-top:15px;">Submit</button>
</form>
<div id="customerSuccess" style="display:none; margin-top:20px; font-size:22px; font-weight:bold;">You are registered!</div>
</div>

<div id="adminLoginBtn">Admin Area (Password required)</div>

<!-- Admin Section -->
<div id="adminSection" style="display:none;">
<div class="container">
<header>
<h1>Werkleiter Matching</h1>
<p>Automatic Grouping</p>
</header>

<div class="input-section">
<h2>Add Participants</h2>
<form id="participant-form">
<div class="form-group"><label>Name</label><input id="name" required></div>
<div class="form-group"><label>Role</label>
<select id="role" required>
<option value="">Select Role</option>
<option value="commercial">Commercial</option>
<option value="technical">Technical</option>
</select>
</div>
<div class="form-group"><label>Factory / Location</label><input id="factory" required></div>
<div class="form-group"><label>We offer</label><textarea id="we-offer" required></textarea></div>
<div class="form-group"><label>We seek</label><textarea id="we-seek" required></textarea></div>
<div class="form-group"><label>Key Takeaways</label><textarea id="key-takeaways"></textarea></div>
<div class="form-group"><label>Contact Partners</label><textarea id="contact-partners"></textarea></div>
<button class="btn btn-success">Add Participant</button>
</form>

<div id="participants-list" style="margin-top:30px;">
<h3>Participants</h3>
<div id="participants-container"></div>
</div>
</div>

<div class="results-section">
<h2>Create Groups</h2>
<button id="create-groups" class="btn" style="margin-bottom:20px;">Generate Groups</button>
<div id="loading" class="loading" style="display:none;">
<div class="spinner"></div>
<p>AI is analyzing participants...</p>
</div>
<div id="results-container"></div>
</div>
</div>
</div>

<script>
// --- Firebase init ---
const firebaseConfig = {
  apiKey: "AIzaSyCoNXOOdXyrDU43I3oaAQhNzD-sW9qlIk4",
  authDomain: "werkleiter-mat.firebaseapp.com",
  projectId: "werkleiter-mat",
  storageBucket: "werkleiter-mat.firebasestorage.app",
  messagingSenderId: "274812390256",
  appId: "1:274812390256:web:181e0a87484ec283a95db5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- Participants Array ---
let participants = [];

// --- Admin Login ---
document.getElementById("adminLoginBtn").onclick = () => {
    let password = prompt("Enter admin password:");
    if(password !== "admin123") { alert("Wrong password!"); return; }
    document.getElementById("adminSection").style.display = "block";
    document.getElementById("customerSection").style.display = "none";
    document.getElementById("adminLoginBtn").style.display = "none";
};

// --- Listen to Firebase participants live ---
db.collection("participants").orderBy("created").onSnapshot(snapshot => {
    participants = [];
    snapshot.forEach(doc => {
        participants.push({...doc.data(), id: doc.id});
    });
    updateParticipantsList();
});

// --- Customer form submit to Firebase ---
document.getElementById("customerForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    const entry = {
        name: document.getElementById("c-name").value,
        role: document.getElementById("c-role").value, // Rolle hinzufügen
        factory: document.getElementById("c-factory").value,
        weOffer: document.getElementById("c-offer").value,
        weSeek: document.getElementById("c-seek").value,
        keyTakeaways: document.getElementById("c-key-takeaways").value,
        contactPartners: document.getElementById("c-contact-partners").value,
        created: firebase.firestore.FieldValue.serverTimestamp()
    };
    db.collection("participants").add(entry).then(()=>{
        document.getElementById("customerForm").reset();
        document.getElementById("customerForm").style.display = "none";
        document.getElementById("customerSuccess").style.display = "block";
    });
});

// --- Update Participants list ---
const participantsContainer = document.getElementById('participants-container');
function updateParticipantsList(){
    participantsContainer.innerHTML = '';
    if(participants.length === 0) {
        participantsContainer.innerHTML = '<p>No participants yet.</p>';
        return;
    }
    participants.forEach((p,index)=>{
        const card=document.createElement('div');
        card.className='participant-card';
        card.innerHTML=`
        <strong>${p.name}</strong>
        <span class="role-badge role-${p.role}">${p.role==='commercial'?'Commercial':'Technical'}</span>
        <br><br>
        <strong>Factory:</strong> ${p.factory}<br>
        <strong>Offer:</strong> ${p.weOffer}<br>
        <strong>Seek:</strong> ${p.weSeek}<br>
        <strong>Key Takeaways:</strong> ${p.keyTakeaways || '-'}<br>
        <strong>Contact Partners:</strong> ${p.contactPartners || '-'}<br><br>
        <button onclick="removeParticipant('${p.id}')" class="btn" style="background:#e74c3c;">Remove</button>`;
        participantsContainer.appendChild(card);
    });
}

// --- Remove participant ---
window.removeParticipant=function(id){
    db.collection("participants").doc(id).delete();
};

// --- Admin add participant manually ---
document.getElementById('participant-form').addEventListener('submit',(e)=>{
    e.preventDefault();
    const p = {
        name: document.getElementById('name').value,
        role: document.getElementById('role').value,
        factory: document.getElementById('factory').value,
        weOffer: document.getElementById('we-offer').value,
        weSeek: document.getElementById('we-seek').value,
        keyTakeaways: document.getElementById('key-takeaways').value,
        contactPartners: document.getElementById('contact-partners').value,
        created: firebase.firestore.FieldValue.serverTimestamp()
    };
    db.collection("participants").add(p);
    document.getElementById('participant-form').reset();
});

// --- KI & Group generation ---
const API_KEY = "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";
const createGroupsBtn = document.getElementById('create-groups');
const resultsContainer = document.getElementById('results-container');
const loadingElement = document.getElementById('loading');

async function callChatGPT(prompt) {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [
                { role: "system", content: "You are an assistant for Werkleiter Matching. Create 4 groups from participants. Use fields Name, Role, We Offer, We Seek, Key Takeaways, Contact Partners." },
                { role: "user", content: prompt }
            ]
        })
    });
    const data = await response.json();
    if (!data.choices || !data.choices[0].message) throw new Error("Invalid API response");
    return data.choices[0].message.content;
}

createGroupsBtn.addEventListener('click', async ()=>{
    if(participants.length<4){ alert("At least 4 participants required."); return; }

    loadingElement.style.display='block';
    resultsContainer.innerHTML='';

    try {
        const prompt = `Create 4 groups from the following participants:\n${JSON.stringify(participants,null,2)}\nFormat:\n## Group 1\nMembers: ...\nExplanation: ...`;
        const text = await callChatGPT(prompt);

        const groups = text.split("## ").filter(x=>x.trim()!=="");
        resultsContainer.innerHTML = "";

        groups.forEach(group=>{
            const lines = group.split("\n").map(l=>l.trim());
            const title = lines[0];
            let members="", expl="";
            lines.forEach(l=>{
                if(l.toLowerCase().startsWith("members:")) members=l.replace(/Members:/i,"").trim();
                if(l.toLowerCase().startsWith("explanation:")) expl=l.replace(/Explanation:/i,"").trim();
            });
            const box=document.createElement("div");
            box.className="participant-card";
            box.innerHTML=`<h3>${title}</h3><div><strong>Members:</strong> ${members}</div><button class="btn" style="margin-top:10px;padding:5px 10px;">Show Explanation</button><div class="explanation-full">${expl}</div>`;
            const btn = box.querySelector("button");
            const exp = box.querySelector(".explanation-full");
            btn.onclick=()=>{ exp.style.display = exp.style.display==="block"?"none":"block"; };
            resultsContainer.appendChild(box);
        });

    } catch(e) {
        resultsContainer.innerHTML="<p>Error with AI.</p>";
    }

    loadingElement.style.display='none';
});

// --- Example participants ---
const exampleParticipants = [
  {name:"Alice",role:"commercial",factory:"Berlin",weOffer:"Logistics",weSeek:"Supplies",keyTakeaways:"Efficiency",contactPartners:"Bob"},
  {name:"Bob",role:"technical",factory:"Munich",weOffer:"Engineering",weSeek:"Components",keyTakeaways:"Innovation",contactPartners:"Alice"},
  {name:"Charlie",role:"commercial",factory:"Hamburg",weOffer:"Consulting",weSeek:"Partners",keyTakeaways:"Networking",contactPartners:"David"},
  {name:"David",role:"technical",factory:"Frankfurt",weOffer:"Maintenance",weSeek:"Tools",keyTakeaways:"Safety",contactPartners:"Charlie"},
  {name:"Eva",role:"commercial",factory:"Stuttgart",weOffer:"Marketing",weSeek:"Clients",keyTakeaways:"Branding",contactPartners:"Frank"},
  {name:"Frank",role:"technical",factory:"Cologne",weOffer:"Automation",weSeek:"Parts",keyTakeaways:"Precision",contactPartners:"Eva"},
  {name:"Grace",role:"commercial",factory:"Leipzig",weOffer:"Sales",weSeek:"Leads",keyTakeaways:"Growth",contactPartners:"Hannah"},
  {name:"Hannah",role:"technical",factory:"Dresden",weOffer:"Support",weSeek:"Hardware",keyTakeaways:"Reliability",contactPartners:"Grace"},
  {name:"Ian",role:"commercial",factory:"Bremen",weOffer:"Strategy",weSeek:"Consultants",keyTakeaways:"Planning",contactPartners:"Jack"},
  {name:"Jack",role:"technical",factory:"Nuremberg",weOffer:"Software",weSeek:"APIs",keyTakeaways:"Integration",contactPartners:"Ian"},
  {name:"Karen",role:"commercial",factory:"Hannover",weOffer:"Finance",weSeek:"Investors",keyTakeaways:"Profit",contactPartners:"Leo"},
  {name:"Leo",role:"technical",factory:"Dortmund",weOffer:"Production",weSeek:"Materials",keyTakeaways:"Efficiency",contactPartners:"Karen"},
  {name:"Mona",role:"commercial",factory:"Essen",weOffer:"HR",weSeek:"Talents",keyTakeaways:"Teamwork",contactPartners:"Nina"},
  {name:"Nina",role:"technical",factory:"Bonn",weOffer:"Design",weSeek:"Components",keyTakeaways:"Innovation",contactPartners:"Mona"},
  {name:"Oscar",role:"commercial",factory:"Kiel",weOffer:"Legal",weSeek:"Guidance",keyTakeaways:"Compliance",contactPartners:"Paul"},
  {name:"Paul",role:"technical",factory:"Magdeburg",weOffer:"IT",weSeek:"Software",keyTakeaways:"Security",contactPartners:"Oscar"},
  {name:"Quinn",role:"commercial",factory:"Mainz",weOffer:"Procurement",weSeek:"Vendors",keyTakeaways:"Cost-saving",contactPartners:"Rita"},
  {name:"Rita",role:"technical",factory:"Saarbrücken",weOffer:"Testing",weSeek:"Tools",keyTakeaways:"Quality",contactPartners:"Quinn"},
  {name:"Sam",role:"commercial",factory:"Freiburg",weOffer:"Research",weSeek:"Data",keyTakeaways:"Insights",contactPartners:"Tina"},
  {name:"Tina",role:"technical",factory:"Heidelberg",weOffer:"Support",weSeek:"Hardware",keyTakeaways:"Reliability",contactPartners:"Sam"},
  {name:"Uma",role:"commercial",factory:"Ulm",weOffer:"Consulting",weSeek:"Clients",keyTakeaways:"Networking",contactPartners:"Victor"},
  {name:"Victor",role:"technical",factory:"Würzburg",weOffer:"Engineering",weSeek:"Parts",keyTakeaways:"Innovation",contactPartners:"Uma"},
  {name:"Wendy",role:"commercial",factory:"Regensburg",weOffer:"Marketing",weSeek:"Partners",keyTakeaways:"Branding",contactPartners:"Xander"},
  {name:"Xander",role:"technical",factory:"Kassel",weOffer:"Automation",weSeek:"Components",keyTakeaways:"Precision",contactPartners:"Wendy"},
  {name:"Yara",role:"commercial",factory:"Augsburg",weOffer:"Sales",weSeek:"Leads",keyTakeaways:"Growth",contactPartners:"Zane"},
  {name:"Zane",role:"technical",factory:"Potsdam",weOffer:"Maintenance",weSeek:"Tools",keyTakeaways:"Safety",contactPartners:"Yara"},
];

// --- Add example participants to Firebase (only if DB is empty) ---
db.collection("participants").get().then(snapshot=>{
    if(snapshot.empty){
        exampleParticipants.forEach(p=>{
            db.collection("participants").add({...p, created: firebase.firestore.FieldValue.serverTimestamp()});
        });
    }
});
</script>
</body>
</html>

